# Use the Docker-in-Docker (dind) service for building images
image: docker:20.10.16
services:
  - docker:20.10.16-dind

variables:
  # Replace with your actual registry path
  DOCKER_REGISTRY: $CI_REGISTRY
  # Replace with your image name
  DOCKER_IMAGE: $DOCKER_REGISTRY/$CI_PROJECT_PATH
  
# Define the stages of your pipeline
stages:
  - build
  - deploy

# Job to build and push the Docker image
build-image:
  stage: build
  script:
    # Login to GitLab's built-in container registry
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    # Build the image based on your Dockerfile
    - docker build -t $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA .
    # Push the image to the registry
    - docker push $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA
  # Only run for pushes to the 'main' branch
  only:
    - main

# Job to deploy the application
# (Deployment is highly dependent on your environment: K8s, VM, etc.)
deploy-app:
  stage: deploy
  script:
    - echo "Deployment script goes here, e.g., SSH into server and run docker-compose pull/up"
  # Requires the build stage to have succeeded
  needs: ["build-image"]
  only:
    - main

