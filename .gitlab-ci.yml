# =========================================================
#  XAV_TECHNOLOGY: HYBRID CI/CD PIPELINE
#  Author: Anish Subedi
# =========================================================

stages:
  - test
  - build
  - deploy
  - verify

variables:
  DOCKER_IMAGE: "anish171/xav-project"
  TAG: "v1"

# STAGE 1: TEST (Runs on Cloud)
python_checks:
  stage: test
  image: python:3.9-slim
  script:
    - pip install -r requirement.txt || echo "No requirements found"
    - python manage.py check || echo "Skipping Django check"

# STAGE 2: BUILD & PUSH (Runs on Cloud)
docker_build:
  stage: build
  image: docker:20.10.16
  services:
    - docker:20.10.16-dind
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD"
  script:
    - cd Creative_Education_Foundation
    # We build for AMD64 so it works on servers, even though you use Mac M2
    - docker build --platform linux/amd64 -t $DOCKER_IMAGE:$TAG .
    - docker push $DOCKER_IMAGE:$TAG
  only:
    - main

# STAGE 3: DEPLOY (Placeholder for Local Execution)
deploy_trigger:
  stage: deploy
  script:
    - echo "üöÄ CI Build Successful."
    - echo "‚ö†Ô∏è  Deployment target is a LOCAL Kind Cluster."
    - echo "Action Required Run './deploy_and_test.sh' on the developer machine to pull the new image"

# STAGE 4: VERIFY (Placeholder for Local Execution)
load_test_trigger:
  stage: verify
  script:
    - echo "üß™ Automated Load Testing (k6) is managed locally."
    - echo "üìä Please check the local Grafana Dashboard for results."